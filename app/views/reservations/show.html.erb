<div class="mx-auto w-full" data-controller="approve">
  <h1>
    <%= @reservation.program.unit.name %> Reservation
  </h1>
  <% if is_student?(current_user) && allow_student_to_edit_reservation?(@reservation) || 
    is_manager?(current_user) && allow_manager_to_edit_reservation?(@reservation)%>
    <p class="body-md-text mt-2 text-blue-900">
      If you need to edit the reservation, please cancel it and create a new one, 
      or you can email <%= unit_email(@reservation) %> or call the office at: <%= contact_phone(@reservation) %>
    </p>
  <% end %>
  <h2 class="mb-4">
    <%= @reservation.program.display_name_with_title %>
  </h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="col-span-3">
      <% if is_admin?(current_user) %>
        <%= form_with model: @reservation, html: { class: "sm:flex sm:items-center" },
          data: {
                  approve_target: "form"
                } do |f| %>
          <div class="sm:col-span-4">
            <ol class="switches">
              <li>
                <%= f.check_box :approved, "data-action": "change->approve#toggleApprove" %>
                <%= f.label :approved do %>
                  <span class="label-text">Approved</span>
                  <span></span>
                <% end %>
              </li>
            </ol>
          </div>
        <% end %>
        <div class="error_text" id="approve_error"></div>
      <% end %>
      <%= render @reservation %>
    </div>
    <div class="order-first md:order-last">
      <div class="lg:flex lg:flex-col place-items-end whitespace-nowrap">
        <% if is_admin?(current_user) && !@reservation.approved %>
          <% if recurring?(@reservation) %>
            <%= form_tag cancel_recurring_reservation_url, method: :post, local: true,
              data: {
                  approve_target: "form1"
                } do |form| %>
              <div class="my-2">
                <label for="cancel_type" class="fancy_label">Cancel Recurring Reservation</label>
                <%= select_tag :cancel_type, options_for_select(cancel_types), include_blank: "Select to Cancel ...", class: "filter_select",
                "data-approve-target": "cancel_type", "data-action": "change->approve#cancelReservation" %>
              </div>
              <div>
                <%= link_to 'Approve All Recurring Reservations', approve_all_recurring_path(@reservation), class: "secondary_blue_button" %>
              </div>
            <% end %>
          <% else %>
            <%= link_to reservation_path(@reservation), data: { turbo_confirm: 'Are you sure?', turbo_method: :delete} do %>
              <span class="tertiary_button">Cancel Reservation
                <i class="fa fa-times" aria-hidden="true"></i>
              </span>
            <% end %>
          <% end %>
        <% end %>
        <% if (is_admin?(current_user)) && @reservation.end_time > DateTime.now %>
          <div class="my-2">
            <% if @reservation.start_time.to_date == @reservation.end_time.to_date %>
              <%= link_to 'Edit Reservation', edit_reservation_path(@reservation), class: "primary_button" if policy(@reservation).edit? %>
            <% else %>
              <%= link_to 'Edit Reservation', edit_long_reservation_path(@reservation), class: "primary_button" if policy(@reservation).edit? %>
            <% end %>
          </div>
          <div>
            <%= link_to 'Send Reservation Update', send_reservation_updated_email_path(@reservation), class: "secondary_yellow_button w-1", data: { turbo_confirm: 'Are you sure?', turbo_method: :get} if policy(@reservation).edit? %>
          </div>
        <% end %>
        <% if (is_student?(current_user) && allow_student_to_edit_reservation?(@reservation) || is_manager?(current_user) && allow_manager_to_edit_reservation?(@reservation)) && !@reservation.approved %>
          <% if recurring?(@reservation) %>
            <%= form_tag cancel_recurring_reservation_url, method: :post, local: true,
              data: {
                  approve_target: "form1"
                } do |form| %>
              <div class="my-2">
                <label for="cancel_type" class="fancy_label">Cancel Recurring Reservation</label>
                <%= select_tag :cancel_type, options_for_select(cancel_types), include_blank: "Select to Cancel ...", class: "filter_select",
                "data-approve-target": "cancel_type", "data-action": "change->approve#cancelReservation" %>
              </div>
            <% end %>
          <% else %>
            <%= link_to reservation_path(@reservation), data: { turbo_confirm: 'Are you sure?', turbo_method: :delete} do %>
              <span class="tertiary_button">Cancel Reservation
                <i class="fa fa-times" aria-hidden="true"></i>
              </span>
            <% end %>
          <% end %>
        <% end %>
        <div class="my-2">
          <% if is_admin?(current_user) %>
            <% if @reservation.vehicle_report.present? %>
              <%= link_to 'Vehicle Report', vehicle_report_path(@reservation.vehicle_report), class: "secondary_blue_button" if @reservation.car.present? %>
            <% else %>
              <%= link_to 'New Vehicle Report', new_reservation_vehicle_report_path(@reservation), class: "secondary_blue_button" if @reservation.car.present? %>
            <% end %>
          <% end %>
          <% if is_student?(current_user) && Reservation.no_or_not_complete_vehicle_reports.exists?(@reservation.id) %>
            <% if @reservation.vehicle_report.present? %>
              <%= link_to 'Vehicle Report', vehicle_report_path(@reservation.vehicle_report), class: "secondary_blue_button" if @reservation.car.present? %>
            <% else %>
              <%= link_to 'New Vehicle Report', new_reservation_vehicle_report_path(@reservation), class: "secondary_blue_button" if @reservation.car.present? %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <% if is_admin?(current_user) %>
    <%= render 'email_logs/email_log', email_log_entries: @email_log_entries %>
  <% end %>
</div>
